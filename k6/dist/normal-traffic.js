(()=>{"use strict";var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var r in s)e.o(s,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:s[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>v,guestFlow:()=>_,options:()=>p,organizerFlow:()=>m});const s=require("k6/http");var r=e.n(s);const n=require("k6"),o=require("k6/metrics"),i="http://api.52.7.172.243.nip.io",a=new o.Counter("registrations_success"),d=new o.Counter("logins_success"),c=new o.Counter("sessions_created"),l=new o.Counter("photos_uploaded"),g=new o.Counter("heartbeats_sent"),u=new o.Trend("response_time_ms"),p={scenarios:{organizer:{executor:"per-vu-iterations",vus:1,iterations:1,exec:"organizerFlow",startTime:"0s"},guests_arriving:{executor:"ramping-vus",startVUs:0,stages:[{duration:"1m",target:5},{duration:"2m",target:15},{duration:"3m",target:20},{duration:"2m",target:10},{duration:"2m",target:0}],exec:"guestFlow",startTime:"10s"}},thresholds:{http_req_failed:["rate<0.05"],http_req_duration:["p(95)<2000"]}};let h=null;function f(e){const t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t}function m(){const e=`organizer_${Date.now()}@event.de`,t="EventPass2024!",s=`Hochzeit_${(new Date).toISOString().split("T")[0]}`;console.log(`[Organizer] Erstelle Event: ${s}`);const o=r().post(`${i}/auth/register`,JSON.stringify({name:"Event Organisator",email:e,password:t}),{headers:f()});if(!(0,n.check)(o,{"Organizer registriert":e=>201===e.status}))return void console.error("[Organizer] Registrierung fehlgeschlagen");a.add(1),(0,n.sleep)(1);const l=r().post(`${i}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f()});if(!(0,n.check)(l,{"Organizer eingeloggt":e=>201===e.status}))return void console.error("[Organizer] Login fehlgeschlagen");let u;d.add(1);try{u=JSON.parse(l.body).access_token}catch{return void console.error("[Organizer] Token parsing fehlgeschlagen")}(0,n.sleep)(1);const p=r().post(`${i}/sessions/create`,JSON.stringify({settings:{name:s,description:"Willkommen zu unserem Event!"},missions:[{title:"Brautpaar",description:"Foto mit dem Brautpaar"},{title:"Torte",description:"Die Hochzeitstorte"},{title:"Tanzen",description:"Auf der Tanzfläche"}]}),{headers:f(u)});if((0,n.check)(p,{"Session erstellt":e=>201===e.status})){c.add(1);try{const e=JSON.parse(p.body);h=e.id,console.log(`[Organizer] Session erstellt: ${h}`)}catch{console.error("[Organizer] Session ID parsing fehlgeschlagen")}for(let e=0;e<30;e++)(0,n.sleep)(20),h&&(r().post(`${i}/sessions/heartbeat`,JSON.stringify({sessionId:h}),{headers:f(u)}),g.add(1))}else console.error("[Organizer] Session-Erstellung fehlgeschlagen")}function _(){let e=0;for(;!h&&e<30;)(0,n.sleep)(1),e++;if(!h)return void console.warn("[Gast] Keine Session verfügbar, überspringe...");const t=`Gast_${__VU}_${Date.now().toString(36)}`,s=`guest_${Date.now()}_${Math.random().toString(36).substring(7)}@event.de`,o="EventPass2024!";if(Math.random()<.5){const e=r().post(`${i}/auth/register`,JSON.stringify({name:t,email:s,password:o}),{headers:f()});(0,n.check)(e,{"Gast registriert":e=>201===e.status})&&(a.add(1),u.add(e.timings.duration)),(0,n.sleep)(S(1,3))}const c=r().post(`${i}/auth/login`,JSON.stringify({email:s,password:o}),{headers:f()});let l=null;if((0,n.check)(c,{"Gast eingeloggt":e=>201===e.status})){d.add(1),u.add(c.timings.duration);try{l=JSON.parse(c.body).access_token}catch{}}(0,n.sleep)(S(2,5));const p=r().post(`${i}/sessions/registerSessionUser`,JSON.stringify({session_id:h,user_name:t}),{headers:f(l||void 0)});let m=null;if((0,n.check)(p,{"Session beigetreten":e=>201===e.status}))try{m=JSON.parse(p.body).id}catch{}const _=S(60,180),v=Date.now();for(;(Date.now()-v)/1e3<_;){const e=Math.random();e<.3?y(l,h,t):e<.6?O(l,h):m&&(r().post(`${i}/sessions/heartbeat`,JSON.stringify({sessionId:h}),{headers:f(l||void 0)}),g.add(1)),(0,n.sleep)(S(5,30))}}function y(e,t,s){const o=r().post(`${i}/pictures/init-upload`,JSON.stringify({session_id:t,original_filename:`foto_${Date.now()}.jpg`,mimetype:"image/jpeg",u_name:s}),{headers:f(e||void 0)});if(!(0,n.check)(o,{"Upload initiiert":e=>201===e.status}))return;let a,d;try{const e=JSON.parse(o.body);a=e.uploadUrl,d=e.pictureId}catch{return}const c=r().put(a,"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",{headers:{"Content-Type":"image/jpeg"}});if(!(0,n.check)(c,{"S3 Upload OK":e=>200===e.status}))return;const g=r().post(`${i}/pictures/finalize-upload`,JSON.stringify({pictureId:d}),{headers:f(e||void 0)});(0,n.check)(g,{"Upload finalisiert":e=>201===e.status})&&(l.add(1),u.add(o.timings.duration+g.timings.duration))}function O(e,t){const s=r().get(`${i}/pictures/session?session_id=${t}`,{headers:f(e||void 0)});(0,n.check)(s,{"Gallery geladen":e=>200===e.status}),u.add(s.timings.duration)}function S(e,t){return Math.random()*(t-e)+e}function v(){}var A=exports;for(var w in t)A[w]=t[w];t.__esModule&&Object.defineProperty(A,"__esModule",{value:!0})})();