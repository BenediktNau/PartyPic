(()=>{"use strict";var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var r in s)e.o(s,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:s[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>v,guestFlow:()=>_,options:()=>p,organizerFlow:()=>m});const s=require("k6/http");var r=e.n(s);const o=require("k6"),n=require("k6/metrics"),i="http://api.52.7.172.243.nip.io",a=new n.Counter("registrations_success"),d=new n.Counter("logins_success"),c=new n.Counter("sessions_created"),u=new n.Counter("photos_uploaded"),l=new n.Counter("heartbeats_sent"),g=new n.Trend("response_time_ms"),p={scenarios:{organizer:{executor:"per-vu-iterations",vus:1,iterations:1,exec:"organizerFlow",startTime:"0s"},guests_arriving:{executor:"ramping-vus",startVUs:0,stages:[{duration:"1m",target:5},{duration:"2m",target:15},{duration:"3m",target:20},{duration:"2m",target:10},{duration:"2m",target:0}],exec:"guestFlow",startTime:"10s"}},thresholds:{http_req_failed:["rate<0.05"],http_req_duration:["p(95)<2000"]}};let h=null;function f(e){const t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t}function m(){const e=`organizer_${Date.now()}@event.de`,t="EventPass2024!",s=`Hochzeit_${(new Date).toISOString().split("T")[0]}`;console.log(`Erstelle Event: ${s}`);const n=r().post(`${i}/auth/register`,JSON.stringify({name:"Event Organisator",email:e,password:t}),{headers:f()});if(!(0,o.check)(n,{"register ok":e=>201===e.status}))return void console.error("Registrierung fehlgeschlagen");a.add(1),(0,o.sleep)(1);const u=r().post(`${i}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f()});if(!(0,o.check)(u,{"login ok":e=>201===e.status}))return void console.error("Login fehlgeschlagen");let g;d.add(1);try{g=JSON.parse(u.body).access_token}catch{return void console.error("Token parsing error")}(0,o.sleep)(1);const p=r().post(`${i}/sessions/create`,JSON.stringify({settings:{name:s,description:"Willkommen!"},missions:[{title:"Brautpaar",description:"Foto mit dem Brautpaar"},{title:"Torte",description:"Die Hochzeitstorte"},{title:"Tanzen",description:"Auf der TanzflÃ¤che"}]}),{headers:f(g)});if((0,o.check)(p,{"session created":e=>201===e.status})){c.add(1);try{h=JSON.parse(p.body).id,console.log(`Session erstellt: ${h}`)}catch{console.error("Session ID parsing error")}for(let e=0;e<30;e++)(0,o.sleep)(20),h&&(r().post(`${i}/sessions/heartbeat`,JSON.stringify({sessionId:h}),{headers:f(g)}),l.add(1))}else console.error("Session erstellen fehlgeschlagen")}function _(){let e=0;for(;!h&&e<30;)(0,o.sleep)(1),e++;if(!h)return void console.warn("Keine Session gefunden");const t=`Gast_${__VU}_${Date.now().toString(36)}`,s=`guest_${Date.now()}_${Math.random().toString(36).substring(7)}@event.de`,n="EventPass2024!";if(Math.random()<.5){const e=r().post(`${i}/auth/register`,JSON.stringify({name:t,email:s,password:n}),{headers:f()});(0,o.check)(e,{"guest registered":e=>201===e.status})&&(a.add(1),g.add(e.timings.duration)),(0,o.sleep)(A(1,3))}const c=r().post(`${i}/auth/login`,JSON.stringify({email:s,password:n}),{headers:f()});let u=null;if((0,o.check)(c,{"guest login":e=>201===e.status})){d.add(1),g.add(c.timings.duration);try{u=JSON.parse(c.body).access_token}catch{}}(0,o.sleep)(A(2,5));const p=r().post(`${i}/sessions/registerSessionUser`,JSON.stringify({session_id:h,user_name:t}),{headers:f(u||void 0)});let m=null;if((0,o.check)(p,{"joined session":e=>201===e.status}))try{m=JSON.parse(p.body).id}catch{}const _=A(60,180),v=Date.now();for(;(Date.now()-v)/1e3<_;){const e=Math.random();e<.3?y(u,h,t):e<.6?S(u,h):m&&(r().post(`${i}/sessions/heartbeat`,JSON.stringify({sessionId:h}),{headers:f(u||void 0)}),l.add(1)),(0,o.sleep)(A(5,30))}}function y(e,t,s){const n=r().post(`${i}/pictures/init-upload`,JSON.stringify({session_id:t,original_filename:`foto_${Date.now()}.jpg`,mimetype:"image/jpeg",u_name:s}),{headers:f(e||void 0)});if(!(0,o.check)(n,{"init upload":e=>201===e.status}))return;let a,d;try{const e=JSON.parse(n.body);a=e.uploadUrl,d=e.pictureId}catch{return}const c=r().put(a,"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",{headers:{"Content-Type":"image/jpeg"}});if(!(0,o.check)(c,{"s3 upload":e=>200===e.status}))return;const l=r().post(`${i}/pictures/finalize-upload`,JSON.stringify({pictureId:d}),{headers:f(e||void 0)});(0,o.check)(l,{finalize:e=>201===e.status})&&(u.add(1),g.add(n.timings.duration+l.timings.duration))}function S(e,t){const s=r().get(`${i}/pictures/session?session_id=${t}`,{headers:f(e||void 0)});(0,o.check)(s,{"gallery loaded":e=>200===e.status}),g.add(s.timings.duration)}function A(e,t){return Math.random()*(t-e)+e}function v(){}var w=exports;for(var O in t)w[O]=t[O];t.__esModule&&Object.defineProperty(w,"__esModule",{value:!0})})();