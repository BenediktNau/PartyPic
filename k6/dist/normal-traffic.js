(()=>{"use strict";var e={n:s=>{var o=s&&s.__esModule?()=>s.default:()=>s;return e.d(o,{a:o}),o},d:(s,o)=>{for(var t in o)e.o(o,t)&&!e.o(s,t)&&Object.defineProperty(s,t,{enumerable:!0,get:o[t]})},o:(e,s)=>Object.prototype.hasOwnProperty.call(e,s),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},s={};e.r(s),e.d(s,{default:()=>M,options:()=>y,setup:()=>S,teardown:()=>$});const o=require("k6"),t=require("k6/http");var n=e.n(t);function a(e="user"){const s=Date.now(),o=Math.floor(1e4*Math.random());return{email:`${e}_${s}_${o}@loadtest.local`,password:`Test123!${o}`,username:`${e}_user_${o}`}}function i(e,s){const t=n().post(`${e}/auth/register`,JSON.stringify({email:s.email,password:s.password,username:s.username}),{headers:{"Content-Type":"application/json"}}),a=(0,o.check)(t,{"registration successful":e=>201===e.status||200===e.status});return a||console.log("Registration failed for "+s.email+" - Status: "+t.status+" - Body: "+t.body),a}function r(e,s){const t=n().post(`${e}/auth/login`,JSON.stringify({email:s.email,password:s.password}),{headers:{"Content-Type":"application/json"}}),a=(0,o.check)(t,{"login successful":e=>200===e.status||201===e.status});if(a&&t.json()){const e=t.json();return e.access_token||e.token||null}return a||console.log("Login failed for "+s.email+" - Status: "+t.status),null}function l(e,s){const t=n().post(`${e}/sessions/create`,"",{headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}}),a=(0,o.check)(t,{"session created":e=>201===e.status||200===e.status});return a&&t.json()?{id:t.json().sessionId,name:"LoadTest Session"}:(a||console.log("Session creation failed - Status: "+t.status+" - Body: "+t.body),null)}function c(e,s,t){const a=n().post(`${e}/pictures/init-upload`,JSON.stringify({session_id:s,mimetype:t}),{headers:{"Content-Type":"application/json"}});return(0,o.check)(a,{"upload initialized":e=>200===e.status||201===e.status})&&a.json()?a.json():null}function u(e,s){const t=n().put(e,s,{headers:{"Content-Type":"image/jpeg"}});return(0,o.check)(t,{"image uploaded":e=>200===e.status})}function d(e,s,t,a,i,r,l){const c=n().post(`${e}/pictures/finalize-upload`,JSON.stringify({u_name:s,session_id:t,s3_key:a,original_filename:i,filesize_bytes:r,mimetype:l}),{headers:{"Content-Type":"application/json"}});return(0,o.check)(c,{"upload finalized":e=>200===e.status||201===e.status})}function p(e,s){const t=n().get(`${e}/pictures/session?sessionId=${s}`);return(0,o.check)(t,{"gallery loaded":e=>200===e.status})}function g(e,s){const t=n().post(`${e}/sessions/heartbeat`,JSON.stringify({userId:s}),{headers:{"Content-Type":"application/json"}});return(0,o.check)(t,{"heartbeat sent":e=>200===e.status||201===e.status})}function f(e=50){const s=1024*e,o=new Uint8Array(s);o[0]=255,o[1]=216,o[2]=255,o[3]=224;for(let e=4;e<s-2;e++)o[e]=Math.floor(256*Math.random());return o[s-2]=255,o[s-1]=217,o.buffer}function m(){return 1+2*Math.random()}function h(e){return e*(50+100*Math.random())/1e3}const y={stages:[{duration:"2m",target:50},{duration:"3m",target:150},{duration:"3m",target:300},{duration:"2m",target:0}],thresholds:{http_req_duration:["p(95)<3000"],http_req_failed:["rate<0.10"]}},_=[],j=5;function S(){const e=__ENV.APP_URL||"http://localhost:3000";console.log("Starting Normal Traffic Simulation"),console.log("Target URL: "+e),console.log("Creating "+j+" sessions..."),console.log(""),console.log("Testing connectivity to: "+e);const s=n().get(e);console.log("Base URL test - Status: "+s.status),console.log("");for(let s=0;s<j;s++){const t=a(`admin_session${s}`);if(i(e,t)){(0,o.sleep)(.5);const n=r(e,t);if(n){(0,o.sleep)(.5);const t=l(e,n);t?(_.push(t),console.log("Session "+(s+1)+" created: "+t.id)):console.log("Session creation failed for admin "+(s+1))}else console.log("Login failed for admin "+(s+1))}else console.log("Registration failed for admin "+(s+1));(0,o.sleep)(.5)}return console.log("Setup complete: "+_.length+" sessions ready"),0===_.length&&console.error("FATAL: No sessions were created! Check backend connectivity."),{baseUrl:e,sessions:_}}function M(e){const s=e.baseUrl,t=e.sessions;t&&0!==t.length?function(e,s){const t=a("normal");(0,o.sleep)(m()),(0,o.sleep)(h(t.email.length)),(0,o.sleep)(.5),(0,o.sleep)(h(t.username.length)),(0,o.sleep)(.5),(0,o.sleep)(h(12));if(!i(e,t))return void console.log("Registration failed for "+t.email);(0,o.sleep)(m()),(0,o.sleep)(h(t.email.length)),(0,o.sleep)(.3),(0,o.sleep)(h(12));if(!r(e,t))return void console.log("Login failed");(0,o.sleep)(m());const l=function(e,s,t){const a=n().post(`${e}/sessions/registerSessionUser`,JSON.stringify({username:s,sessionId:t}),{headers:{"Content-Type":"application/json"}});if((0,o.check)(a,{"session user registered":e=>200===e.status||201===e.status})&&a.json()){const e=a.json();return e.id||e.userId||null}return null}(e,t.username,s.id);l&&(t.sessionUserId=l,g(e,l)),(0,o.sleep)(.5),function(e,s){const t=n().get(`${e}/sessions/get?sessionId=${s}`);(0,o.check)(t,{"session retrieved":e=>200===e.status})}(e,s.id),(0,o.sleep)(1+2*Math.random()),l&&g(e,l),p(e,s.id),(0,o.sleep)(1+Math.random()),l&&g(e,l);const y=2+Math.floor(3*Math.random());for(let n=0;n<y;n++){(0,o.sleep)(2+3*Math.random()),l&&g(e,l);const a=`photo_${Date.now()}_${n}.jpg`,i=100,r=f(i),p=c(e,s.id,"image/jpeg");p&&p.uploadUrl&&p.key?((0,o.sleep)(.3),u(p.uploadUrl,r)&&((0,o.sleep)(.3),d(e,t.username,s.id,p.key,a,1024*i,"image/jpeg"),console.log("User uploaded image "+(n+1)+"/"+y)),(0,o.sleep)(1+Math.random())):console.log("Init upload failed, skipping image")}(0,o.sleep)(m()),l&&g(e,l),p(e,s.id),(0,o.sleep)(3+5*Math.random()),l&&g(e,l),Math.random()>.5&&((0,o.sleep)(m()),p(e,s.id),(0,o.sleep)(2+3*Math.random()),l&&g(e,l))}(s,t[Math.floor(Math.random()*t.length)]):console.error("No sessions available! Aborting.")}function $(e){console.log("Normal Traffic Test complete"),console.log("Tested "+e.sessions.length+" sessions")}var b=exports;for(var k in s)b[k]=s[k];s.__esModule&&Object.defineProperty(b,"__esModule",{value:!0})})();