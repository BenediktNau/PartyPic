(()=>{"use strict";var e={n:s=>{var t=s&&s.__esModule?()=>s.default:()=>s;return e.d(t,{a:t}),t},d:(s,t)=>{for(var a in t)e.o(t,a)&&!e.o(s,a)&&Object.defineProperty(s,a,{enumerable:!0,get:t[a]})},o:(e,s)=>Object.prototype.hasOwnProperty.call(e,s),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},s={};e.r(s),e.d(s,{default:()=>m,options:()=>g,setup:()=>h,teardown:()=>_});const t=require("k6/http");var a=e.n(t);const n=require("k6"),o=require("k6/metrics"),r=new o.Counter("registrations_success"),i=new o.Counter("logins_success"),d=new o.Counter("sessions_created"),c=new o.Counter("photos_uploaded"),u=new o.Counter("heartbeats_sent"),p=new o.Rate("errors"),l=new o.Trend("api_latency"),f=__ENV.API_URL||"http://api.52.7.172.243.nip.io",g={scenarios:{realistic_users:{executor:"ramping-vus",startVUs:0,stages:[{duration:"30s",target:5},{duration:"1m",target:20},{duration:"2m",target:50},{duration:"2m",target:50},{duration:"1m",target:20},{duration:"30s",target:0}],gracefulRampDown:"30s"}},thresholds:{http_req_duration:["p(95)<3000"],errors:["rate<0.2"]}};function y(){return new Uint8Array("ffd8ffe000104a46494600010100000100010000ffdb004300080606070605080707070909080a0c140d0c0b0b0c1912130f141d1a1f1e1d1a1c1c20242e2720222c231c1c2837292c30313434341f27393d38323c2e333432ffdb0043010909090c0b0c180d0d1832211c213232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232ffc00011080001000103012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00fdfca28a2800a28a2803ffd9".match(/.{1,2}/g).map(e=>parseInt(e,16))).buffer}const b={token:null,userId:null,sessionId:null,sessionUserId:null};function m(){const e=__VU,s=function(e){const s=`${e}_${__ITER}_${Date.now()}`;return{username:`testuser_${s}`,email:`test_${s}@loadtest.local`,password:"TestPassword123!"}}(e);if((0,n.group)("1. User Registration",()=>{const e=a().post(`${f}/auth/register`,JSON.stringify({username:s.username,email:s.email,password:s.password}),{headers:{"Content-Type":"application/json"},tags:{name:"Register"}}),t=(0,n.check)(e,{"Registration successful (201/200)":e=>201===e.status||200===e.status});t&&r.add(1),p.add(!t),l.add(e.timings.duration),(0,n.sleep)(1)}),(0,n.group)("2. User Login",()=>{const e=a().post(`${f}/auth/login`,JSON.stringify({email:s.email,password:s.password}),{headers:{"Content-Type":"application/json"},tags:{name:"Login"}}),t=(0,n.check)(e,{"Login successful":e=>200===e.status||201===e.status,"Token received":e=>{try{return void 0!==JSON.parse(e.body).access_token}catch{return!1}}});if(t){i.add(1);try{const s=JSON.parse(e.body);b.token=s.access_token,b.userId=s.user_id||s.userId||s.sub}catch{}}p.add(!t),l.add(e.timings.duration),(0,n.sleep)(.5)}),!b.token)return console.log(`VU ${e}: Login failed, skipping remaining phases`),void(0,n.sleep)(2);(0,n.group)("3. Session Management",()=>{if(Math.random()>.5){const e=function(e,s,t,n){const o={"Content-Type":"application/json"};n&&(o.Authorization=`Bearer ${n}`);const r={headers:o};return a().post(s,t?JSON.stringify(t):null,r)}(0,`${f}/sessions/create`,{},b.token);if((0,n.check)(e,{"Session created":e=>200===e.status||201===e.status})){d.add(1);try{const s=JSON.parse(e.body);b.sessionId=s.sessionId}catch{}}l.add(e.timings.duration)}if(b.sessionId){const e=a().post(`${f}/sessions/registerSessionUser`,JSON.stringify({username:s.username,sessionId:b.sessionId}),{headers:{"Content-Type":"application/json"},tags:{name:"RegisterSessionUser"}});(0,n.check)(e,{"Session user registered":e=>200===e.status||201===e.status});try{const s=JSON.parse(e.body);b.sessionUserId=s.id||s.userId}catch{}l.add(e.timings.duration)}(0,n.sleep)(1)}),(0,n.group)("4. Party Activity (Photos & Heartbeats)",()=>{const e=Math.floor(3*Math.random())+3;for(let t=0;t<e;t++){if(b.sessionUserId&&200===a().post(`${f}/sessions/heartbeat`,JSON.stringify({userId:b.sessionUserId}),{headers:{"Content-Type":"application/json"},tags:{name:"Heartbeat"}}).status&&u.add(1),b.sessionId&&Math.random()>.4){const e=a().post(`${f}/pictures/init-upload`,JSON.stringify({session_id:b.sessionId,mimetype:"image/jpeg"}),{headers:{"Content-Type":"application/json"},tags:{name:"InitUpload"}});if(200===e.status||201===e.status)try{const t=JSON.parse(e.body),n=t.uploadUrl,o=t.key;if(n&&o){const e=y();if(200===a().put(n,e,{headers:{"Content-Type":"image/jpeg"},tags:{name:"S3Upload"}}).status){const t=a().post(`${f}/pictures/finalize-upload`,JSON.stringify({u_name:s.username,session_id:b.sessionId,s3_key:o,original_filename:`party_photo_${Date.now()}.jpg`,filesize_bytes:e.byteLength,mimetype:"image/jpeg"}),{headers:{"Content-Type":"application/json"},tags:{name:"FinalizeUpload"}});200!==t.status&&201!==t.status||c.add(1)}}}catch{}}(0,n.sleep)(3*Math.random()+2)}}),(0,n.group)("5. View Gallery",()=>{if(b.sessionId){const e=a().get(`${f}/pictures/session?sessionId=${b.sessionId}`,{headers:{"Content-Type":"application/json"},tags:{name:"GetGallery"}});(0,n.check)(e,{"Gallery loaded":e=>200===e.status}),l.add(e.timings.duration)}(0,n.sleep)(1)}),b.sessionUserId&&(a().post(`${f}/sessions/heartbeat`,JSON.stringify({userId:b.sessionUserId}),{headers:{"Content-Type":"application/json"},tags:{name:"Heartbeat"}}),u.add(1)),b.token=null,b.userId=null,b.sessionId=null,b.sessionUserId=null,(0,n.sleep)(1)}function h(){console.log(`\n╔════════════════════════════════════════════════════════════════╗\n║           PartyPic Realistic User Flow Test                    ║\n╠════════════════════════════════════════════════════════════════╣\n║  API URL: ${f.padEnd(52)}║\n╠════════════════════════════════════════════════════════════════╣\n║  Simulating real user journeys:                                ║\n║  1. Register new account                                       ║\n║  2. Login                                                      ║\n║  3. Create/Join session                                        ║\n║  4. Upload photos                                              ║\n║  5. Send heartbeats                                            ║\n║  6. View gallery                                               ║\n╠════════════════════════════════════════════════════════════════╣\n║  Metrics to watch in Grafana:                                  ║\n║  - partypic_active_sessions                                    ║\n║  - partypic_users_online                                       ║\n║  - partypic_photos_uploaded_total                              ║\n║  - partypic_http_requests_total                                ║\n╚════════════════════════════════════════════════════════════════╝\n  `);const e=a().get(`${f}/`);200!==e.status?console.warn(`⚠️  API not reachable: ${e.status}`):console.log("✅ API is reachable")}function _(){console.log("\n╔════════════════════════════════════════════════════════════════╗\n║                 Realistic Test Complete                        ║\n╠════════════════════════════════════════════════════════════════╣\n║  Check Grafana dashboards for:                                 ║\n║  - Active sessions created                                     ║\n║  - Online users (via heartbeats)                               ║\n║  - Photos uploaded                                             ║\n║  - Request patterns per endpoint                               ║\n╚════════════════════════════════════════════════════════════════╝\n  ")}var I=exports;for(var S in s)I[S]=s[S];s.__esModule&&Object.defineProperty(I,"__esModule",{value:!0})})();