(()=>{"use strict";var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var o in s)e.o(s,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:s[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{createSessionFlow:()=>A,default:()=>$,options:()=>h,photoUploadFlow:()=>w,setup:()=>O,teardown:()=>T,userFlow:()=>y});const s=require("k6/http");var o=e.n(s);const r=require("k6"),n=require("k6/metrics"),i="http://api.52.7.172.243.nip.io",a=new n.Counter("registrations_success"),d=new n.Counter("logins_success"),l=new n.Counter("sessions_created"),c=new n.Counter("photos_uploaded"),u=new n.Counter("heartbeats_sent"),p=new n.Trend("response_time_ms"),g=new n.Rate("error_rate"),h={scenarios:{ramp_up:{executor:"ramping-vus",startVUs:0,stages:[{duration:"30s",target:50},{duration:"1m",target:150},{duration:"2m",target:300},{duration:"3m",target:400},{duration:"2m",target:200},{duration:"1m",target:50},{duration:"30s",target:0}],exec:"userFlow"},session_creators:{executor:"constant-arrival-rate",rate:10,timeUnit:"1s",duration:"8m",preAllocatedVUs:50,maxVUs:100,exec:"createSessionFlow",startTime:"30s"},photo_uploaders:{executor:"constant-arrival-rate",rate:20,timeUnit:"1s",duration:"7m",preAllocatedVUs:100,maxVUs:200,exec:"photoUploadFlow",startTime:"1m"}},thresholds:{http_req_failed:["rate<0.10"],http_req_duration:["p(95)<5000"],error_rate:["rate<0.15"]}},m=[];function _(){const e=Date.now(),t=Math.random().toString(36).substring(7);return`peak_${__VU||0}_${e}_${t}@load.test`}function f(e){const t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t}function S(){return 0===m.length?null:m[Math.floor(Math.random()*m.length)]}function y(){const e=_(),t="LoadTest2024!",s=`User_${__VU}_${__ITER}`,n=o().post(`${i}/auth/register`,JSON.stringify({name:s,email:e,password:t}),{headers:f(),timeout:"10s"}),l=(0,r.check)(n,{"Registrierung OK":e=>201===e.status});g.add(!l),l&&(a.add(1),p.add(n.timings.duration)),(0,r.sleep)(.5);const c=o().post(`${i}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f(),timeout:"10s"});let h=null;const m=(0,r.check)(c,{"Login OK":e=>201===e.status});if(g.add(!m),m){d.add(1),p.add(c.timings.duration);try{h=JSON.parse(c.body).access_token}catch{}}(0,r.sleep)(.3);const y=S();if(y&&h){const e=o().post(`${i}/sessions/registerSessionUser`,JSON.stringify({session_id:y,user_name:s}),{headers:f(h),timeout:"10s"});(0,r.check)(e,{"Session beigetreten":e=>201===e.status}),(0,r.sleep)(.2);for(let e=0;e<3;e++)o().post(`${i}/sessions/heartbeat`,JSON.stringify({sessionId:y}),{headers:f(h),timeout:"5s"}),u.add(1),(0,r.sleep)(.2),o().get(`${i}/pictures/session?session_id=${y}`,{headers:f(h),timeout:"10s"}),(0,r.sleep)(.3)}}function A(){const e=_(),t="LoadTest2024!",s=`Creator_${__VU}_${__ITER}`,n=o().post(`${i}/auth/register`,JSON.stringify({name:s,email:e,password:t}),{headers:f(),timeout:"15s"});if(!(0,r.check)(n,{"Creator registriert":e=>201===e.status}))return void g.add(!0);a.add(1),(0,r.sleep)(.3);const c=o().post(`${i}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f(),timeout:"15s"});if(!(0,r.check)(c,{"Creator eingeloggt":e=>201===e.status}))return void g.add(!0);let u;d.add(1);try{u=JSON.parse(c.body).access_token}catch{return}(0,r.sleep)(.2);const p=o().post(`${i}/sessions/create`,JSON.stringify({settings:{name:`Event_${Date.now()}`,description:"Load Test Event"},missions:[{title:"Mission 1",description:"Beschreibung"},{title:"Mission 2",description:"Beschreibung"}]}),{headers:f(u),timeout:"10s"});if((0,r.check)(p,{"Session erstellt":e=>201===e.status})){l.add(1);try{const e=JSON.parse(p.body);e.id&&(m.push(e.id),m.length>100&&m.shift())}catch{}}else g.add(!0)}function w(){const e=S();if(!e)return void(0,r.sleep)(1);const t=`Uploader_${__VU}_${__ITER}`,s=o().post(`${i}/pictures/init-upload`,JSON.stringify({session_id:e,original_filename:`peak_${Date.now()}.jpg`,mimetype:"image/jpeg",u_name:t}),{headers:f(),timeout:"10s"});if(!(0,r.check)(s,{"Upload init OK":e=>201===e.status}))return void g.add(!0);let n,a;try{const e=JSON.parse(s.body);n=e.uploadUrl,a=e.pictureId}catch{return void g.add(!0)}const d=o().put(n,"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",{headers:{"Content-Type":"image/jpeg"},timeout:"15s"});if(!(0,r.check)(d,{"S3 Upload OK":e=>200===e.status}))return void g.add(!0);const l=o().post(`${i}/pictures/finalize-upload`,JSON.stringify({pictureId:a}),{headers:f(),timeout:"10s"});(0,r.check)(l,{"Finalize OK":e=>201===e.status})?(c.add(1),p.add(s.timings.duration+l.timings.duration)):g.add(!0)}function $(){}function O(){console.log("========================================"),console.log("PEAK TRAFFIC TEST GESTARTET"),console.log("========================================"),console.log("Ziel: HPA und Cluster Autoscaler triggern"),console.log("Max VUs: 400"),console.log("Erwartete Pods: 2 â†’ 25"),console.log("========================================");const e=`setup_${Date.now()}@load.test`,t="LoadTest2024!";if(201!==o().post(`${i}/auth/register`,JSON.stringify({name:"Setup User",email:e,password:t}),{headers:f()}).status)return console.warn("Setup: Registrierung fehlgeschlagen"),{sessions:[]};const s=o().post(`${i}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f()});if(201!==s.status)return console.warn("Setup: Login fehlgeschlagen"),{sessions:[]};let r;try{r=JSON.parse(s.body).access_token}catch{return{sessions:[]}}const n=[];for(let e=0;e<5;e++){const t=o().post(`${i}/sessions/create`,JSON.stringify({settings:{name:`InitialSession_${e}`,description:"Initial Load Test Session"},missions:[{title:"Test",description:"Test"}]}),{headers:f(r)});if(201===t.status)try{const e=JSON.parse(t.body);e.id&&(n.push(e.id),m.push(e.id))}catch{}}return console.log(`Setup: ${n.length} Sessions erstellt`),{sessions:n}}function T(e){console.log("========================================"),console.log("PEAK TRAFFIC TEST BEENDET"),console.log("========================================"),console.log(`Sessions erstellt: ${l}`),console.log(`Fotos hochgeladen: ${c}`),console.log("========================================")}var U=exports;for(var b in t)U[b]=t[b];t.__esModule&&Object.defineProperty(U,"__esModule",{value:!0})})();