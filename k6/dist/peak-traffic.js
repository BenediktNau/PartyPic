(()=>{"use strict";var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var o in s)e.o(s,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:s[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{createSessionFlow:()=>A,default:()=>w,options:()=>h,photoUploadFlow:()=>$,setup:()=>O,teardown:()=>T,userFlow:()=>S});const s=require("k6/http");var o=e.n(s);const r=require("k6"),i=require("k6/metrics"),n=__ENV.BASE_URL||"http://localhost:3000",a=new i.Counter("registrations_success"),d=new i.Counter("logins_success"),u=new i.Counter("sessions_created"),c=new i.Counter("photos_uploaded"),l=new i.Counter("heartbeats_sent"),p=new i.Trend("response_time_ms"),g=new i.Rate("error_rate"),h={scenarios:{ramp_up:{executor:"ramping-vus",startVUs:0,stages:[{duration:"30s",target:50},{duration:"1m",target:150},{duration:"2m",target:300},{duration:"3m",target:400},{duration:"2m",target:200},{duration:"1m",target:50},{duration:"30s",target:0}],exec:"userFlow"},session_creators:{executor:"constant-arrival-rate",rate:10,timeUnit:"1s",duration:"8m",preAllocatedVUs:50,maxVUs:100,exec:"createSessionFlow",startTime:"30s"},photo_uploaders:{executor:"constant-arrival-rate",rate:20,timeUnit:"1s",duration:"7m",preAllocatedVUs:100,maxVUs:200,exec:"photoUploadFlow",startTime:"1m"}},thresholds:{http_req_failed:["rate<0.10"],http_req_duration:["p(95)<5000"],error_rate:["rate<0.15"]}},_=[];function m(){return`peak_${__VU||0}_${Date.now()}_${Math.random().toString(36).substring(7)}@load.test`}function f(e){const t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t}function y(){return 0===_.length?null:_[Math.floor(Math.random()*_.length)]}function S(){const e=m(),t="LoadTest2024!",s=`User_${__VU}_${__ITER}`,i=o().post(`${n}/auth/register`,JSON.stringify({name:s,email:e,password:t}),{headers:f(),timeout:"10s"}),u=(0,r.check)(i,{register:e=>201===e.status});g.add(!u),u&&(a.add(1),p.add(i.timings.duration)),(0,r.sleep)(.5);const c=o().post(`${n}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f(),timeout:"10s"});let h=null;const _=(0,r.check)(c,{login:e=>201===e.status});if(g.add(!_),_){d.add(1),p.add(c.timings.duration);try{h=JSON.parse(c.body).access_token}catch{}}(0,r.sleep)(.3);const S=y();if(S&&h){const e=o().post(`${n}/sessions/registerSessionUser`,JSON.stringify({session_id:S,user_name:s}),{headers:f(h),timeout:"10s"});(0,r.check)(e,{join:e=>201===e.status}),(0,r.sleep)(.2);for(let e=0;e<3;e++)o().post(`${n}/sessions/heartbeat`,JSON.stringify({sessionId:S}),{headers:f(h),timeout:"5s"}),l.add(1),(0,r.sleep)(.2),o().get(`${n}/pictures/session?session_id=${S}`,{headers:f(h),timeout:"10s"}),(0,r.sleep)(.3)}}function A(){const e=m(),t="LoadTest2024!",s=`Creator_${__VU}_${__ITER}`,i=o().post(`${n}/auth/register`,JSON.stringify({name:s,email:e,password:t}),{headers:f(),timeout:"15s"});if(!(0,r.check)(i,{"creator reg":e=>201===e.status}))return void g.add(!0);a.add(1),(0,r.sleep)(.3);const c=o().post(`${n}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f(),timeout:"15s"});if(!(0,r.check)(c,{"creator login":e=>201===e.status}))return void g.add(!0);let l;d.add(1);try{l=JSON.parse(c.body).access_token}catch{return}(0,r.sleep)(.2);const p=o().post(`${n}/sessions/create`,JSON.stringify({settings:{name:`Event_${Date.now()}`,description:"Load Test"},missions:[{title:"Test 1",description:"desc"},{title:"Test 2",description:"desc"}]}),{headers:f(l),timeout:"10s"});if((0,r.check)(p,{session:e=>201===e.status})){u.add(1);try{const e=JSON.parse(p.body);e.id&&(_.push(e.id),_.length>100&&_.shift())}catch{}}else g.add(!0)}function $(){const e=y();if(!e)return void(0,r.sleep)(1);const t=`Uploader_${__VU}_${__ITER}`,s=o().post(`${n}/pictures/init-upload`,JSON.stringify({session_id:e,original_filename:`peak_${Date.now()}.jpg`,mimetype:"image/jpeg",u_name:t}),{headers:f(),timeout:"10s"});if(!(0,r.check)(s,{init:e=>201===e.status}))return void g.add(!0);let i,a;try{const e=JSON.parse(s.body);i=e.uploadUrl,a=e.pictureId}catch{return void g.add(!0)}const d=o().put(i,"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",{headers:{"Content-Type":"image/jpeg"},timeout:"15s"});if(!(0,r.check)(d,{s3:e=>200===e.status}))return void g.add(!0);const u=o().post(`${n}/pictures/finalize-upload`,JSON.stringify({pictureId:a}),{headers:f(),timeout:"10s"});(0,r.check)(u,{finalize:e=>201===e.status})?(c.add(1),p.add(s.timings.duration+u.timings.duration)):g.add(!0)}function w(){}function O(){console.log("=== PEAK TRAFFIC TEST ==="),console.log("Ziel: 2 -> 25 Pods");const e=`setup_${Date.now()}@load.test`,t="LoadTest2024!";if(201!==o().post(`${n}/auth/register`,JSON.stringify({name:"Setup",email:e,password:t}),{headers:f()}).status)return{sessions:[]};const s=o().post(`${n}/auth/login`,JSON.stringify({email:e,password:t}),{headers:f()});if(201!==s.status)return{sessions:[]};let r;try{r=JSON.parse(s.body).access_token}catch{return{sessions:[]}}const i=[];for(let e=0;e<5;e++){const t=o().post(`${n}/sessions/create`,JSON.stringify({settings:{name:`Init_${e}`,description:"Setup"},missions:[{title:"Test",description:"test"}]}),{headers:f(r)});if(201===t.status)try{const e=JSON.parse(t.body);e.id&&(i.push(e.id),_.push(e.id))}catch{}}return console.log(`${i.length} Sessions erstellt`),{sessions:i}}function T(){console.log("=== TEST BEENDET ===")}var N=exports;for(var U in t)N[U]=t[U];t.__esModule&&Object.defineProperty(N,"__esModule",{value:!0})})();